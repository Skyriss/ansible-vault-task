---
- name: Select Nginx user
  set_fact:
    nginx_user: "www-data"
  when: ansible_facts['os_family'] == 'Debian'

- name: Select Nginx user
  set_fact:
    nginx_user: "nginx"
  when: ansible_facts['os_family'] == 'RedHat'

- name: Create challenge directory
  file:
    path: "{{ nginx_root_dir }}/{{ item }}/.well-known/acme-challenge"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"
    mode: 0555
    state: directory
    
- name: Create ssl directory
  file:
    path: "{{ ssl_key_dir }}/{{ item }}"
    mode: 0750
    state: directory

- name: Find account.key
  stat:
    path: "{{ ssl_key_dir }}/{{ item }}/account.key"
  register: account_key

- name: Generate RSA 4096 account key
  openssl_privatekey:
    path: "{{ ssl_key_dir }}/{{ item }}/account.key"
    type: RSA
    size: 4096
  when: account_key.stat.exists == False

- name: Find domain.key
  stat:
    path: "{{ ssl_key_dir }}/{{ item }}/domain.key"
  register: domain_key

- name: Generate RSA 4096 domain key
  openssl_privatekey:
    path: "{{ ssl_key_dir }}/{{ item }}/domain.key"
    type: RSA
    size: 4096
  when: domain_key.stat.exists == False

- name: Find domain.csr
  stat:
    path: "{{ ssl_key_dir }}/{{ item }}/domain.csr"
  register: domain_csr

- name: Create Certificate Signing Request
  openssl_csr:
    path: "{{ ssl_key_dir }}/{{ item }}/domain.csr"
    privatekey_path: "{{ ssl_key_dir }}/{{ item }}/domain.key"
    common_name: "{{ item }}"

- name: Create a challenge for farstone.devops.rebrain.srwx.net
  acme_certificate:
    account_key_src: "{{ ssl_key_dir }}/{{ item }}/account.key"
    csr: "{{ ssl_key_dir }}/{{ item }}/domain.csr"
    dest: "{{ ssl_key_dir }}/{{ item }}/devops.crt"
    fullchain_dest: "{{ ssl_key_dir }}/{{ item }}/devops-fullchain.pem"
    chain_dest: "{{ ssl_key_dir }}/{{ item }}/devops-chain.pem"
    account_email: "alex.farstone@gmail.com"
    acme_directory: "https://acme-v02.api.letsencrypt.org/directory"
    acme_version: 2
    terms_agreed: "yes"
    challenge: "http-01"
    remaining_days: "{{ letsencrypt_remaining_days }}"
    modify_account: "yes"
  register: create_challenge
  tags: 
    - create-cert

- name: Copy challenge data
  copy:
    content: "{{ create_challenge.challenge_data[item]['http-01']['resource_value'] }}"
    dest: "{{ nginx_root_dir }}/{{ item }}/.well-known/acme-challenge/{{ create_challenge.challenge_data[item]['http-01']['resource'] | basename }}"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"
    mode: 0555
  register: challenge_ok
  tags: 
    - create-cert

- name: Create certificate
  acme_certificate:
    account_key_src: "{{ ssl_key_dir }}/{{ item }}/account.key"
    csr: "{{ ssl_key_dir }}/{{ item }}/domain.csr"
    dest: "{{ ssl_key_dir }}/{{ item }}/signed.crt"
    fullchain_dest: "{{ ssl_key_dir }}/{{ item }}/signed-fullchain.pem"
    chain_dest: "{{ ssl_key_dir }}/{{ item }}/signed-chain.pem"
    account_email: "alex.farstone@gmail.com"
    acme_directory: "https://acme-v02.api.letsencrypt.org/directory"
    acme_version: 2
    terms_agreed: "yes"
    challenge: "http-01"
    remaining_days: "{{ letsencrypt_remaining_days }}"
    modify_account: "yes"
    data: "{{ create_challenge }}"
  register: verify_challenge
  ignore_errors: yes
  tags: 
    - create-cert

- name: Move private key
  copy:
    src: "{{ playbook_dir }}/secretkey"
    dest: "{{ ssl_key_dir }}/{{ item }}/domain.key"
  tags: 
    - copy-cert

- name: Copy certificate
  copy:
    src: "{{ playbook_dir }}/signed.crt"
    dest: "{{ ssl_key_dir }}/{{ item }}/signed.crt"
  tags: 
    - copy-cert
